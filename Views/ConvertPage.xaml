<?xml version="1.0" encoding="UTF-8" ?>
<Page
    x:Class="PandocGUI.Views.ConvertPage"
    x:Name="RootPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="using:PandocGUI"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:PandocGUI.Models"
    mc:Ignorable="d">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*" />
            <!-- File List Panel -->
            <ColumnDefinition Width="Auto" />
            <!-- Divider -->
            <ColumnDefinition Width="380" />
            <!-- Settings Panel -->
        </Grid.ColumnDefinitions>

        <!-- Left Panel: File List -->
        <Grid Grid.Column="0" RowSpacing="12" Padding="24">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Top Toolbar -->
            <StackPanel Orientation="Horizontal" Spacing="8">
                <Button Command="{x:Bind ViewModel.AddFilesCommand}" Style="{StaticResource PrimaryAction}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <SymbolIcon Symbol="Add" />
                        <TextBlock Text="添加文件" />
                    </StackPanel>
                </Button>
                <Button Command="{x:Bind ViewModel.AddFolderCommand}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <SymbolIcon Symbol="Folder" />
                        <TextBlock Text="添加文件夹" />
                    </StackPanel>
                </Button>
                <Border Width="1" Height="20" Background="{ThemeResource DividerStrokeColorDefaultBrush}" Margin="4,0" />
                <Button Command="{x:Bind ViewModel.RemoveSelectedCommand}" ToolTipService.ToolTip="移除选中">
                    <SymbolIcon Symbol="Delete" />
                </Button>
                <Button Command="{x:Bind ViewModel.ClearQueueCommand}" ToolTipService.ToolTip="清空列表">
                    <SymbolIcon Symbol="Clear" />
                </Button>
            </StackPanel>

            <!-- File List Area -->
            <Grid Grid.Row="1" AllowDrop="True" DragOver="OnDragOver" Drop="OnDrop">
                <Border
                    BorderThickness="1"
                    BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}"
                    CornerRadius="8"
                    Background="{ThemeResource LayerFillColorDefaultBrush}">
                    <Grid>
                         <!-- Empty State Hint -->
                        <StackPanel
                            VerticalAlignment="Center"
                            HorizontalAlignment="Center"
                            Spacing="12"
                            Visibility="{x:Bind ViewModel.QueueCount, Mode=OneWay, Converter={StaticResource IntToVisibilityConverter}, ConverterParameter=Inverse}">
                            <SymbolIcon Symbol="Upload" RenderTransformOrigin="0.5,0.5">
                                <SymbolIcon.RenderTransform>
                                    <ScaleTransform ScaleX="2" ScaleY="2" />
                                </SymbolIcon.RenderTransform>
                            </SymbolIcon>
                            <TextBlock
                                Text="拖拽文件到此处"
                                Style="{StaticResource SubtitleTextBlockStyle}"
                                HorizontalAlignment="Center" />
                            <TextBlock
                                Text="支持多选文件或文件夹"
                                Style="{StaticResource CaptionTextBlockStyle}"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                HorizontalAlignment="Center" />
                        </StackPanel>
                        
                        <!-- The List -->
                        <ListView
                            ItemsSource="{x:Bind ViewModel.Queue, Mode=OneWay}"
                            SelectedItem="{x:Bind ViewModel.SelectedItem, Mode=TwoWay}"
                            SelectionMode="Extended">
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="models:ConversionItem">
                                    <Grid Padding="0,8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        
                                        <!-- Icon based on status -->
                                        <SymbolIcon Symbol="Document" Grid.Column="0" Margin="0,0,12,0" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
                                        
                                        <StackPanel Grid.Column="1" Spacing="4">
                                            <TextBlock Text="{x:Bind FileName}" Style="{StaticResource BodyStrongTextBlockStyle}" />
                                            <TextBlock Text="{x:Bind OutputPath}" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" TextTrimming="CharacterEllipsis" />
                                        </StackPanel>
                                        
                                        <!-- Status -->
                                        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                             <TextBlock Text="{x:Bind Status}" VerticalAlignment="Center" Style="{StaticResource CaptionTextBlockStyle}" />
                                        </StackPanel>
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Grid>
                </Border>
            </Grid>

            <!-- Bottom Status Bar (Progress) -->
            <Grid Grid.Row="2" ColumnSpacing="12" Margin="0,12,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <StackPanel Spacing="4" VerticalAlignment="Center">
                    <ProgressBar Maximum="1" Value="{x:Bind ViewModel.QueueProgress, Mode=OneWay}" />
                    <TextBlock Text="{x:Bind ViewModel.QueueSummary, Mode=OneWay}" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                     <Button Command="{x:Bind ViewModel.OpenOutputFolderCommand}" Content="打开输出目录" />
                     <Button Command="{x:Bind ViewModel.ClearLogCommand}" Content="清空日志" />
                </StackPanel>
            </Grid>
        </Grid>

        <!-- Vertical Divider -->
        <Border Grid.Column="1" Width="1" Background="{ThemeResource DividerStrokeColorDefaultBrush}" Margin="0,24" />

        <!-- Right Panel: Settings & Actions -->
        <ScrollViewer Grid.Column="2" Padding="24">
            <StackPanel Spacing="24">
                <TextBlock Text="转换设置" Style="{StaticResource TitleTextBlockStyle}" />
                
                <!-- Format Selection -->
                <StackPanel Spacing="16">
                    <ComboBox Header="预设配置" 
                              ItemsSource="{x:Bind ViewModel.Presets, Mode=OneWay}" 
                              SelectedItem="{x:Bind ViewModel.SelectedPreset, Mode=TwoWay}"
                              DisplayMemberPath="Name"
                              HorizontalAlignment="Stretch" />

                    <Grid ColumnSpacing="12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <ComboBox Header="输入格式" 
                                  ItemsSource="{x:Bind ViewModel.InputFormats, Mode=OneWay}" 
                                  SelectedItem="{x:Bind ViewModel.SelectedInputFormat, Mode=TwoWay}"
                                  HorizontalAlignment="Stretch" />
                        <ComboBox Grid.Column="1" Header="输出格式" 
                                  ItemsSource="{x:Bind ViewModel.OutputFormats, Mode=OneWay}" 
                                  SelectedItem="{x:Bind ViewModel.SelectedOutputFormat, Mode=TwoWay}"
                                  HorizontalAlignment="Stretch" />
                    </Grid>

                    <TextBox Header="输出扩展名" Text="{x:Bind ViewModel.OutputExtension, Mode=TwoWay}" />
                </StackPanel>
                
                <Border Height="1" Background="{ThemeResource DividerStrokeColorDefaultBrush}" Margin="0,4" />

                <!-- Output Path -->
                <StackPanel Spacing="8">
                    <TextBlock Text="输出目录" Style="{StaticResource BodyStrongTextBlockStyle}" />
                    <Grid ColumnSpacing="8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBox Text="{x:Bind ViewModel.OutputDirectory, Mode=TwoWay}" PlaceholderText="默认源文件目录" />
                        <Button Grid.Column="1" Command="{x:Bind ViewModel.BrowseOutputFolderCommand}">
                            <SymbolIcon Symbol="Folder" />
                        </Button>
                    </Grid>
                    <ComboBox Header="最近目录" 
                             ItemsSource="{x:Bind ViewModel.RecentOutputDirectories, Mode=OneWay}"
                             SelectedItem="{x:Bind ViewModel.SelectedRecentOutputDirectory, Mode=TwoWay}"
                             HorizontalAlignment="Stretch" 
                             PlaceholderText="快速选择..." />
                </StackPanel>

                <Border Height="1" Background="{ThemeResource DividerStrokeColorDefaultBrush}" Margin="0,4" />

                <!-- Advanced -->
                <Expander Header="高级选项" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch">
                   <StackPanel Spacing="12" Padding="0,12,0,0">
                       <StackPanel Spacing="8">
                           <TextBlock Text="模板文件" />
                           <Grid ColumnSpacing="8" HorizontalAlignment="Stretch">
                               <Grid.ColumnDefinitions>
                                   <ColumnDefinition Width="*" />
                                   <ColumnDefinition Width="Auto" />
                               </Grid.ColumnDefinitions>
                               <TextBox Text="{x:Bind ViewModel.TemplatePath, Mode=TwoWay}" PlaceholderText="路径..." HorizontalAlignment="Stretch" />
                               <Button Grid.Column="1" Command="{x:Bind ViewModel.BrowseTemplateCommand}" Content="..." />
                           </Grid>
                       </StackPanel>
                       <TextBox Header="额外参数" 
                                Text="{x:Bind ViewModel.AdditionalArgs, Mode=TwoWay}" 
                                AcceptsReturn="True" 
                                Height="80" 
                                TextWrapping="Wrap" 
                                HorizontalAlignment="Stretch" />
                   </StackPanel>
                </Expander>

                <!-- Action Button -->
                <Button Command="{x:Bind ViewModel.StartConversionCommand}" 
                        Style="{StaticResource PrimaryAction}" 
                        HorizontalAlignment="Stretch" 
                        Height="48" Margin="0,12,0,0">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <SymbolIcon Symbol="Play" />
                        <TextBlock Text="开始转换" FontWeight="SemiBold" FontSize="16" />
                    </StackPanel>
                </Button>
                
                 <!-- Status Info -->
                <InfoBar 
                    IsOpen="{x:Bind ViewModel.IsPandocReady, Mode=OneWay, Converter={StaticResource BoolToInverseConverter}}"
                    Severity="Warning" 
                    Title="Pandoc 未就绪"
                    Message="请在设置中检查 Pandoc 环境"
                    IsClosable="False" />
                    
                 <TextBlock Text="{x:Bind ViewModel.WorkflowStatusText, Mode=OneWay}" 
                           Style="{StaticResource CaptionTextBlockStyle}" 
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}" 
                           HorizontalAlignment="Center" 
                           TextAlignment="Center"
                           TextWrapping="Wrap" />

            </StackPanel>
        </ScrollViewer>
    </Grid>

    <Page.Resources>
        <local:IntToVisibilityConverter x:Key="IntToVisibilityConverter" />
        <local:BoolToInverseConverter x:Key="BoolToInverseConverter" />
        <Style x:Key="TitleTextBlockStyle" TargetType="TextBlock" BasedOn="{StaticResource PageTitleText}" />
        <Style x:Key="SubtitleTextBlockStyle" TargetType="TextBlock" BasedOn="{StaticResource SectionTitleText}" />
        <Style x:Key="CaptionTextBlockStyle" TargetType="TextBlock" BasedOn="{StaticResource SubtleText}" />
        <Style x:Key="BodyStrongTextBlockStyle" TargetType="TextBlock">
            <Setter Property="FontWeight" Value="SemiBold" />
        </Style>
    </Page.Resources>
</Page>
